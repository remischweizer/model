<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Model</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
        #header-bar { position: fixed; top: 10px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center; background-color: transparent; z-index: 1000; }
        #header-title { text-align: left; font-family: Arial, sans-serif; }
        .main-title { font-size: 1.8em; font-weight: bold; color: #222; }
        .version { font-size: 0.8em; color: #666; }
        #header-buttons { display: flex; gap: 5px; }
        #header-buttons button { font-size: 1.2em; padding: 8px 12px; cursor: pointer; border: none; background: #f0f0f0; border-radius: 5px; min-width: 40px; }
        #header-buttons button:hover { background: #e0e0e0; }
        #btn-reset { position: relative; display: flex; align-items: center; justify-content: center; min-width: 40px; padding: 8px 12px; font-family: 'Arial Black', Arial, sans-serif; }
        #btn-reset::before { content: "↻"; display: block; font-size: 1.2em; line-height: 1; font-weight: 900; letter-spacing: -0.05em; }
        #btn-pause { font-family: Arial, sans-serif; font-size: 1.2em; min-width: 40px; padding: 8px 12px; position: relative; display: flex; align-items: center; justify-content: center; }
        #btn-pause::before { content: "▶"; display: block; font-size: 1.3em; line-height: 1; }
        #btn-pause.playing::before { content: "❚❚"; font-size: 1.2em; letter-spacing: 1px; font-weight: bold; }
        #compteur { font-size: 3em; margin: 20px; }
        button { padding: 10px 10px; font-size: 1.2em; margin: 5px; }
        #main-content { display: none; margin-top: 60px; }
        #loading-message { font-size: 1.5em; color: #555; }
        #input-container, #output-container { border: 8px solid rgba(50, 49, 49, 0.902); border-radius: 12px; background-color: #f5f5f5; padding: 10px; margin: 10px auto; box-sizing: border-box; }
        #input-container { width: 500px; }
        #output-container { width: 900px; margin: 10px auto; padding: 15px; }
        .blue-zone, .red-zone, .green-zone { padding: 15px; }
        .value-controls { display: flex; justify-content: center; align-items: center; gap: 5px; }
        .value-display { min-width: 40px; text-align: center; font-size: 1.1em; font-weight: bold; }
        .value-btn { padding: 3px 8px; font-size: 0.9em; min-width: 25px; border-radius: 4px; }
        .group-title { margin-top: 0; margin-bottom: 15px; font-size: 1.4em; font-weight: bold; text-align: center; }
        #container-zones { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; flex-wrap: nowrap; align-items: stretch; padding: 15px; }
        .zone { flex: 1; min-width: 0; box-sizing: border-box; margin: 0; }
        .red-zone, .blue-zone { flex: 0 0 28%; min-width: 0; display: flex; flex-direction: column; }
        .red-zone { border-color: #a00000; background-color: #ad4444; color: black; border: 4px solid; border-radius: 15px; padding: 7px; text-align: center; }
        .blue-zone { border-color: #003399; background-color: #3c66a9; color: black; border: 4px solid; border-radius: 15px; padding: 7px; text-align: center; }
        .zone-title { font-weight: bold; font-size: 1.25em; text-align: center; margin-top: 0; margin-bottom: 15px; }
        .red-zone .zone-title, .blue-zone .zone-title { color: white; }
        .zone-subtitle { margin-top: 0; margin-bottom: 10px; font-size: 1em; text-align: center; }
        .item { margin-bottom: 5px; border-radius: 12px; border: 2px solid black; background-color: white; box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); padding: 5px 7px; }
        .item h2 { margin-bottom: 5px; }
        .item div { margin-top: 0; }
        .item:last-child { margin-bottom: 0; }
        .unit { font-size: 0.75em; color: #333; }
        #arrow-container { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px; }
        #arrow-deco { font-size: 6em; margin: 0 15px; display: flex; align-items: center; height: 100%; }
        #io-containers { display: flex; justify-content: center; align-items: center; gap: 20px; }
        #output-container-wrapper { display: flex; flex-direction: column; justify-content: center; height: 100%; }
        #loading-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: rgba(255, 255, 255, 0.9); z-index: 1000; }
        .loader { width: 48px; height: 48px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-size: 1.2em; color: #555; }
        .loading-hint { font-size: 0.9em; font-style: italic; color: #666; margin-top: 10px; max-width: 300px; text-align: center; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); }
        .modal-content {    background-color: #fefefe; margin: 3% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 900px; max-height: 85vh; overflow-y: auto; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);}
        .modal-note { font-size: 0.9em; font-style: italic; color: #666; margin-top: -10px; margin-bottom: 15px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .var-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .var-table th, .var-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .var-table th { background-color: #f2f2f2; }
        .var-table tr:nth-child(even) { background-color: #f9f9f9; }
        .var-table {    width: 100%;    border-collapse: collapse;    margin-top: 15px;    table-layout: fixed; }
        .var-table td {font-size: 0.85em;}
        .var-table td:first-child {font-weight: normal; }
        .var-table td:last-child {font-style: italic; color: #666;}
        .var-table th:nth-child(1),
        .var-table td:nth-child(1) {    width: 35%; }
        .var-table th:nth-child(2),
        .var-table td:nth-child(2) {    width: 20%;}
        .var-table th:nth-child(3),
        .var-table td:nth-child(3) {    width: 45%; }
        .var-table th, .var-table td {    border: 1px solid #ddd;    padding: 10px 12px;     text-align: left;    word-wrap: break-word;    vertical-align: top; }
        .var-table th {     background-color: #f2f2f2;    font-weight: bold;}
        #btn-info { position: relative; display: flex; align-items: center; justify-content: center; min-width: 40px; padding: 8px 12px; font-family: Arial, sans-serif; }
        #btn-info::before { content: "i"; display: block; font-size: 1.2em; line-height: 1; font-weight: bold; font-style: italic; }
        .source-note { position: fixed; bottom: 10px; right: 10px; font-size: 0.8em; color: #666; background-color: rgba(255,255,255,0.7); padding: 3px 6px; border-radius: 3px; }
        #x-axis-legend-container { position: absolute; bottom: 10px; left: 0; right: 0; width: 100%; }
        #x-axis-legend { position: relative; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .legend-line { width: 100%; height: 2px; background-color: #333; position: relative; }
        .legend-marker { position: absolute; top: -5px; width: 2px; height: 10px; background-color: #333; }
        .legend-marker.start { left: 0; }
        .legend-marker.end { right: 0; }
        .legend-label { font-size: 0.8em; color: #333; margin-top: 3px; }
        #green-zone { flex: 0 0 44%; min-width: 0; display: flex; flex-direction: column; height: 100%; }
        .green-zone { border-color: #1a7a1a; background-color: #4CAF50; color: black; border: 4px solid; border-radius: 15px; padding: 7px; text-align: center; box-sizing: border-box; }
        #graph-container { position: relative; border: none !important; border-radius: 10px; background-color: #ffffff; width: 100%; height: 100%; flex-grow: 1; display: flex; flex-direction: column; min-height: 200px; margin: 0; padding: 0; overflow: hidden; }
        #dynamic-graph { width: 100%; height: calc(100% - 30px); flex-grow: 1; }
        #container-zones { padding: 15px; gap: 20px; }
        .red-zone, .blue-zone, .green-zone { margin: 0; }

    </style>
</head>
<body>

    <div id="loading-container">
        <div class="loader"></div>
        <div class="loading-text">Initializing model...</div>
        <div class="loading-hint">
            <em>This may take several tens of seconds and requires an internet connection.</em>
        </div>
    </div>

    <div id="main-content">
        <div id="header-bar">
            <div id="header-title">
                <span class="main-title">Dynamic CO<sub>2</sub> model</span>
                <span class="version">version 1.0</span>
            </div>
            <div id="header-buttons">
                <button id="btn-info"></button>
                <button id="btn-reset"></button>
                <button id="btn-pause"></button>
            </div>
        </div>
        
        <div id="io-containers">
            <div id="input-container">
                <h2 class="group-title">Input variables</h2>
                <div class="item">
                    <h2 class="zone-subtitle">Alveolar ventilation <span class="unit">(L.min<sup>-1</sup>)</span></h2>
                    <div class="value-controls">
                        <button class="value-btn" id="btn-av-minus">-</button>
                        <div class="value-display" id="alveolar_ventilation">6</div>
                        <button class="value-btn" id="btn-av-plus">+</button>
                    </div>
                </div>
                <div class="item">
                    <h2 class="zone-subtitle">Strong Ion Difference variation <span class="unit">(mmol.L<sup>-1</sup>)</span></h2>
                    <div class="value-controls">
                        <button class="value-btn" id="btn-sid-minus">-</button>
                        <div class="value-display" id="sid_variation">0</div>
                        <button class="value-btn" id="btn-sid-plus">+</button>
                    </div>
                </div>
                <div class="item">
                    <h2 class="zone-subtitle">Non-Volatile Weak Acid variation <span class="unit">(mmol.L<sup>-1</sup>)</span></h2>
                    <div class="value-controls">
                        <button class="value-btn" id="btn-atot-minus">-</button>
                        <div class="value-display" id="atot_variation">0</div>
                        <button class="value-btn" id="btn-atot-plus">+</button>
                    </div>
                </div>
                <div class="item">
                    <h2 class="zone-subtitle">Cardiac output <span class="unit">(L.min<sup>-1</sup>)</span></h2>
                    <div class="value-controls">
                        <button class="value-btn" id="btn-co-minus">-</button>
                        <div class="value-display" id="cardiac_output">5</div>
                        <button class="value-btn" id="btn-co-plus">+</button>
                    </div>
                </div>
                <div class="item">
                    <h2 class="zone-subtitle">CO<sub>2</sub> production <span class="unit">(mmol.min<sup>-1</sup>)</span></h2>
                    <div class="value-controls">
                        <button class="value-btn" id="btn-vco2-minus">-</button>
                        <div class="value-display" id="co2_production">3</div>
                        <button class="value-btn" id="btn-vco2-plus">+</button>
                    </div>
                </div>
            </div>
            <div id="io-containers">
                <div id="arrow-deco">➔</div>
            </div>
            
            <div id="output-container">
                <h2 class="group-title">Output variables</h2>
                <div id="container-zones">
                    <div id="venous-zone" class="zone blue-zone">
                        <h3 class="zone-title">Venous</h3>
                        <div class="item">
                            <h2 class="zone-subtitle">pH</h2>
                            <div id="venous_ph">0</div>
                        </div>
                        <div class="item">
                            <h2 class="zone-subtitle">pCO<sub>2</sub> <span class="unit">(mmHg)</span></h2>
                            <div id="venous_pco2">0</div>
                        </div>
                        <div class="item">
                            <h2 class="zone-subtitle">HCO<sub>3</sub><sup>-</sup> <span class="unit">(mmol.L<sup>-1</sup>)</span></h2>
                            <div id="venous_hco3">0</div>
                        </div>
                    </div>
                    <div id="arterial-zone" class="zone red-zone">
                        <h3 class="zone-title">Arterial</h3>
                        <div class="item">
                            <h2 class="zone-subtitle">pH</h2>
                            <div id="arterial_ph">0</div>
                        </div>
                        <div class="item">
                            <h2 class="zone-subtitle">pCO<sub>2</sub> <span class="unit">(mmHg)</span></h2>
                            <div id="arterial_pco2">0</div>
                        </div>
                        <div class="item">
                            <h2 class="zone-subtitle">HCO<sub>3</sub><sup>-</sup> <span class="unit">(mmol.L<sup>-1</sup>)</span></h2>
                            <div id="arterial_hco3">0</div>
                        </div>
                    </div>
                        <div id="green-zone" class="zone green-zone">
                            <div class="item graph-wrapper">
                                <h2 class="zone-subtitle">CO<sub>2</sub> elimination <span class="unit">(mmol.min<sup>-1</sup>)</span></h2>
                                <div id="graph-container">
                                    <canvas id="dynamic-graph"></canvas>
                                    <div id="x-axis-legend-container">
                                        <div id="x-axis-legend">
                                            <div class="legend-line">
                                                <div class="legend-marker start"></div>
                                                <div class="legend-marker end"></div>
                                            </div>
                                            <span class="legend-label">10 min</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
        </div>
        <div id="infoModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Model Calibration</h2>
                <p class="modal-note"><em>Please refer to the original article for detailed explanations.</em></p>

                <h3>Constants</h3>
                <table class="var-table">
                    <thead>
                        <tr>
                            <th>Variable</th>
                            <th>Value</th>
                            <th>Justification</th>
                        </tr>
                    </thead>
                    <tbody id="var-table-const">
                        <!-- lignes constantes insérées ici dynamiquement -->
                    </tbody>
                </table>

                <h3>Baseline Input</h3>
                <table class="var-table">
                    <thead>
                        <tr>
                            <th>Variable</th>
                            <th>Value</th>
                            <th>Justification</th>
                        </tr>
                    </thead>
                    <tbody id="var-table-baseline-input">
                        <!-- lignes baseline input insérées ici dynamiquement -->
                    </tbody>
                </table>

                <h3>Baseline Output</h3>
                <table class="var-table">
                    <thead>
                        <tr>
                            <th>Variable</th>
                            <th>Value</th>
                            <th>Justification</th>
                        </tr>
                    </thead>
                    <tbody id="var-table-baseline-output">
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <div class="source-note">Calculation details available in page source code</div>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script>
        let pyodide;
        let chart;
        const CHART_HISTORY_LENGTH = 50;
        let animationFrameId;

        const INPUTVARIABLES = {
            alveolarVentilation: { default: 6, min: 0, max: 25 },
            sidVariation: { default: 0, min: -100, max: 100 },
            atotVariation: { default: 0, min: -100, max: 100 },
            cardiacOutput: { default: 5, min: 1, max: 15 },
            co2Production: { default: 3, min: 0, max: 10 }
        };

        let alveolarVentilation = INPUTVARIABLES.alveolarVentilation.default;
        let sidVariation = INPUTVARIABLES.sidVariation.default;
        let atotVariation = INPUTVARIABLES.atotVariation.default;
        let cardiacOutput = INPUTVARIABLES.cardiacOutput.default;
        let co2Production = INPUTVARIABLES.co2Production.default;
        let total_volume = 3;

        function updateXAxisLegend() {
            if (!chart) return;
            const BASE_LENGTH_FRACTION = 1/3; 
            const BASE_CO = 5;
            const lengthFraction = (cardiacOutput / BASE_CO) * BASE_LENGTH_FRACTION;
            const graphWidth = chart.width;
            const lineLength = Math.max(50, Math.min(graphWidth * 0.9, graphWidth * lengthFraction));
            const legendLine = document.querySelector('.legend-line');
            if (legendLine) {
                legendLine.style.width = `${lineLength}px`;
            }
            const container = document.getElementById('x-axis-legend-container');
            if (container) {
                container.style.width = `${graphWidth}px`;
            }
        }

        function updateAlveolarVentilation(value) {
            alveolarVentilation = Math.max(INPUTVARIABLES.alveolarVentilation.min, 
                                         Math.min(INPUTVARIABLES.alveolarVentilation.max, value));
            document.getElementById("alveolar_ventilation").textContent = alveolarVentilation;
            updatePythonModel();
        }
        
        function updateSidVariation(value) {
            sidVariation = Math.max(INPUTVARIABLES.sidVariation.min, 
                                  Math.min(INPUTVARIABLES.sidVariation.max, value));
            document.getElementById("sid_variation").textContent = sidVariation;
            updatePythonModel();
        }
        
        function updateAtotVariation(value) {
            atotVariation = Math.max(INPUTVARIABLES.atotVariation.min, 
                                   Math.min(INPUTVARIABLES.atotVariation.max, value));
            document.getElementById("atot_variation").textContent = atotVariation;
            updatePythonModel();
        }
        
        function updateCardiacOutput(value) {
            cardiacOutput = Math.max(INPUTVARIABLES.cardiacOutput.min, 
                                   Math.min(INPUTVARIABLES.cardiacOutput.max, value));
            document.getElementById("cardiac_output").textContent = cardiacOutput;
            updatePythonModel();
            updateXAxisLegend();
        }
        
        function updateCo2Production(value) {
            co2Production = Math.max(INPUTVARIABLES.co2Production.min, 
                                   Math.min(INPUTVARIABLES.co2Production.max, value));
            document.getElementById("co2_production").textContent = co2Production;
            updatePythonModel();
        }

        async function resetToDefaults() {
            updateAlveolarVentilation(INPUTVARIABLES.alveolarVentilation.default);
            updateSidVariation(INPUTVARIABLES.sidVariation.default);
            updateAtotVariation(INPUTVARIABLES.atotVariation.default);
            updateCardiacOutput(INPUTVARIABLES.cardiacOutput.default);
            updateCo2Production(INPUTVARIABLES.co2Production.default);
            updateXAxisLegend();
            
            if (pyodide && pyodide.globals.get("js_reset")) {
                await pyodide.globals.get("js_reset").resetVenousTotalCO2();
            } else {
                console.warn("pyodide or js_reset not fully initialized yet.");
            }
        }
        
        function updatePythonModel() {
            if (pyodide && pyodide.globals.get("js")) {
                pyodide.globals.get("js").alveolarVentilation = alveolarVentilation;
                pyodide.globals.get("js").sidVariation = sidVariation;
                pyodide.globals.get("js").atotVariation = atotVariation;
                pyodide.globals.get("js").cardiacOutput = cardiacOutput;
                pyodide.globals.get("js").co2Production = co2Production;
            } else {
                console.warn("pyodide or js not fully initialized when calling updatePythonModel.");
            }
        }
                
        document.getElementById("btn-av-plus").addEventListener("click", () => updateAlveolarVentilation(alveolarVentilation + 1));
        document.getElementById("btn-av-minus").addEventListener("click", () => updateAlveolarVentilation(alveolarVentilation - 1));
        document.getElementById("btn-sid-plus").addEventListener("click", () => updateSidVariation(sidVariation + 1));
        document.getElementById("btn-sid-minus").addEventListener("click", () => updateSidVariation(sidVariation - 1));
        document.getElementById("btn-atot-plus").addEventListener("click", () => updateAtotVariation(atotVariation + 1));
        document.getElementById("btn-atot-minus").addEventListener("click", () => updateAtotVariation(atotVariation - 1));
        document.getElementById("btn-co-plus").addEventListener("click", () => updateCardiacOutput(cardiacOutput + 1));
        document.getElementById("btn-co-minus").addEventListener("click", () => updateCardiacOutput(cardiacOutput - 1));
        document.getElementById("btn-vco2-plus").addEventListener("click", () => updateCo2Production(co2Production + 1));
        document.getElementById("btn-vco2-minus").addEventListener("click", () => updateCo2Production(co2Production - 1));
        document.getElementById("btn-reset").addEventListener("click", async () => {await resetToDefaults();});

        async function main() {
            pyodide = await loadPyodide({
                indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
            });
            
            await pyodide.loadPackage(["sympy", "pillow", "numpy"]);

            const ctx = document.getElementById('dynamic-graph').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: CHART_HISTORY_LENGTH }, (_, i) => ''),
                    datasets: [{
                        label: 'CO₂ elimination',
                        data: Array.from({ length: CHART_HISTORY_LENGTH }, () => null),
                        borderColor: '#24801e',
                        backgroundColor: 'rgba(36, 128, 30, 0.2)',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    scales: {
                        x: {
                            display: false,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: '#333',
                                stepSize: 1,
                                precision: 0, 
                                callback: function(value) {
                                    if (value % 1 === 0) {
                                        return value;
                                    }
                                },
                            },
                            suggestedMax: 6
                        }
                    },
                    backgroundColor: '#ffffff',
                    onResize: function(chart, size) {
                        updateXAxisLegend();
                    }
                }
            });

            updateXAxisLegend();

            pyodide.globals.set("js", {
                document: window.document,
                Date: window.Date,
                JSON: window.JSON,
                updateChart: (newValue) => {
                    if (!chart) return;
                    const jsValue = Number(newValue); 
                    
                    chart.data.datasets[0].data.push(jsValue);
                    
                    if (chart.data.datasets[0].data.length > CHART_HISTORY_LENGTH) {
                        chart.data.datasets[0].data.shift();
                    }
                    chart.update();
                },
                
                get alveolarVentilation() { return alveolarVentilation; },
                get sidVariation() { return sidVariation; },
                get atotVariation() { return atotVariation; },
                get cardiacOutput() { return cardiacOutput; },
                get co2Production() { return co2Production; }
            });

            pyodide.globals.set("js_reset", {
                resetVenousTotalCO2: async () => {
                    await pyodide.runPython(`
                        next_venous_total_co2 = baseline_venous_total_co2
                        print("Venous total CO2 reset to baseline:", baseline_venous_total_co2)
                    `);
                }
            });
            
            
            await pyodide.runPython(`

                import sys
                import asyncio
                import math
                import numpy as np
                from sympy import symbols, solve

                pkw = 13.6
                kw = 10 ** (-pkw)
                pka = 7.0
                ka = 10 ** (-pka)
                pk1 = 6.1
                k1 = 10 ** (-pk1)
                pk2 = 10.22
                k2 = 10 ** (-pk2)
                S = 0.00003

                def _solve_polynomial(strong_ion_difference, non_volatile_weak_acid, total_co2):
                    coeffs = [
                        1,
                        k1 + ka + strong_ion_difference,
                        k1 * k2 + ka * k1 - kw - non_volatile_weak_acid * ka - total_co2 * k1 + k1 * strong_ion_difference + ka * strong_ion_difference,
                        ka * k1 * k2 - kw * k1 - kw * ka - non_volatile_weak_acid * ka * k1 - 2 * total_co2 * k1 * k2 - ka * total_co2 * k1 + k1 * k2 * strong_ion_difference + ka * k1 * strong_ion_difference,
                        ka * k1 * k2 * strong_ion_difference - kw * k1 * k2 - kw * ka * k1 - non_volatile_weak_acid * ka * k1 * k2 - 2 * ka * total_co2 * k1 * k2,
                        - kw * ka * k1 * k2
                    ]
                    roots = np.roots(coeffs)
                    roots_real = roots[np.isreal(roots)].real
                    valid_roots = [r for r in roots_real if r > 0]
                    if not valid_roots:
                        raise ValueError("Aucune racine réelle positive trouvée pour le polynôme")
                    return max(valid_roots)

                total_volume = 3
                baseline_strong_ion_difference = 0.049
                baseline_non_volatile_weak_acid = 0.035
                baseline_alveolar_ventilation = 6
                baseline_co2_production = 0.003
                baseline_cardiac_output = 5
                baseline_arterial_ph = 7.40
                baseline_arterial_pco2 = 40

                baseline_arterial_h = 10 ** (-baseline_arterial_ph)
                baseline_arterial_total_co2 = baseline_arterial_pco2 * S + k1 * baseline_arterial_pco2 * S / baseline_arterial_h + k1 * k2 * baseline_arterial_pco2 * S / (baseline_arterial_h ** 2)
                baseline_venous_total_co2 = baseline_arterial_total_co2 + baseline_co2_production / baseline_cardiac_output
                baseline_venous_x = symbols('baseline_venous_x')
                baseline_venous_h = _solve_polynomial(
                    strong_ion_difference=baseline_strong_ion_difference,
                    non_volatile_weak_acid=baseline_non_volatile_weak_acid,
                    total_co2=baseline_venous_total_co2
                )      
                baseline_venous_pco2 = baseline_venous_total_co2 / ((1 + k1 / baseline_venous_h + k1 * k2 / (baseline_venous_h ** 2)) * S)
                baseline_co2_elimination = - baseline_co2_production
                baseline_alveolar_pco2 = baseline_arterial_pco2        
                K = baseline_alveolar_pco2 * baseline_alveolar_ventilation / baseline_co2_elimination
                D = baseline_co2_elimination / (baseline_alveolar_pco2 - baseline_venous_pco2 )


                arterial_ph = 0
                arterial_pco2 = 0
                arterial_hco3 = 0
                arterial_total_co2 = 0
                venous_ph = 0
                venous_pco2 = 0
                venous_hco3 = 0
                venous_total_co2 = 0
                co2_elimination = 0
                co2_production = 0
                elapsed_time_between_successive_values = 0
                next_venous_total_co2 = baseline_venous_total_co2

                is_paused = False

                def update_display():
                    js.document.getElementById("arterial_ph").textContent = f"{arterial_ph:.2f}"
                    js.document.getElementById("arterial_pco2").textContent = f"{arterial_pco2:.0f}"
                    js.document.getElementById("arterial_hco3").textContent = f"{arterial_hco3*1000:.1f}"
                    js.document.getElementById("venous_ph").textContent = f"{venous_ph:.2f}"
                    js.document.getElementById("venous_pco2").textContent = f"{venous_pco2:.0f}"
                    js.document.getElementById("venous_hco3").textContent = f"{venous_hco3*1000:.1f}"
                    js.updateChart(-co2_elimination * 1000)

                async def increment_loop():
                    global next_venous_total_co2, arterial_ph, arterial_pco2, arterial_hco3, arterial_total_co2, venous_ph, venous_pco2, venous_hco3, venous_total_co2, co2_elimination, co2_production
                    while True:
                        if not is_paused:
                            alveolar_ventilation = float(js.alveolarVentilation)
                            strong_ion_difference = baseline_strong_ion_difference + float(js.sidVariation) / 1000
                            non_volatile_weak_acid = baseline_non_volatile_weak_acid + float(js.atotVariation) / 1000
                            cardiac_output = float(js.cardiacOutput)
                            co2_production = float(js.co2Production) / 1000
                            venous_total_co2 = next_venous_total_co2
                            venous_h = _solve_polynomial(
                                strong_ion_difference=strong_ion_difference,
                                non_volatile_weak_acid=non_volatile_weak_acid,
                                total_co2=venous_total_co2
                            )
                            venous_ph = -math.log10(venous_h)
                            venous_pco2 = venous_h ** 2 * venous_total_co2 / ((venous_h ** 2 + k1 * venous_h + k1 * k2) * S)
                            venous_hco3 = k1 * venous_h * venous_total_co2 / (venous_h ** 2 + k1 * venous_h + k1 * k2)            
                            co2_elimination = alveolar_ventilation * D * venous_pco2 / (D * K - alveolar_ventilation)
                            arterial_total_co2 = venous_total_co2 + co2_elimination / cardiac_output            
                            arterial_h = _solve_polynomial(
                                strong_ion_difference=strong_ion_difference,
                                non_volatile_weak_acid=non_volatile_weak_acid,
                                total_co2=arterial_total_co2
                            )
                            arterial_ph = -math.log10(arterial_h)
                            arterial_pco2 = arterial_h ** 2 * arterial_total_co2 / ((arterial_h ** 2 + k1 * arterial_h + k1 * k2) * S)
                            arterial_hco3 = k1 * arterial_h * arterial_total_co2 / (arterial_h ** 2 + k1 * arterial_h + k1 * k2)

                            sys.stdout.flush()
                            
                            update_display()
                            next_venous_total_co2 = arterial_total_co2 + co2_production / cardiac_output
                        await asyncio.sleep(.1)

                asyncio.ensure_future(increment_loop())

                def toggle_pause():
                    global is_paused
                    is_paused = not is_paused
                    return is_paused
            `);

            document.getElementById("loading-container").style.display = "none";
            document.getElementById("main-content").style.display = "block";

            document.getElementById("btn-pause").addEventListener("click", async () => {
                const isPaused = await pyodide.runPython(`toggle_pause()`);
                const btn = document.getElementById("btn-pause");
                btn.classList.toggle("playing", !isPaused);
            });

            document.getElementById("btn-pause").classList.add("playing");
        }
        
        main();
        
        
        function formatScientific(number, decimals = 2) {
            if (number === 0) return "0";
            if (Math.abs(number) >= 0.001 && Math.abs(number) < 10000) {
                return number.toFixed(decimals);
            }
            return number.toExponential(decimals);
        }
        
        async function showInitVariables() {
            if (!pyodide) {
                console.error("Pyodide not loaded yet");
                return;
            }

            try {
                const values = await pyodide.runPython(`
                    [
                        kw, ka, k1, k2, S, D, K,
                        total_volume, baseline_strong_ion_difference, 
                        baseline_non_volatile_weak_acid, baseline_alveolar_ventilation,
                        baseline_co2_production, baseline_cardiac_output,
                        baseline_arterial_ph, baseline_arterial_pco2, baseline_venous_pco2
                    ]
                `).toJs();
                const constants = [
                    { name: "Water dissociation constant", value: formatScientific(values[0], 2), unit: "mol².L⁻²", description: "", justification: "From reference <a href='https://doi.org/10.1186/s41077-023-00255-2' target='_blank'>doi.org/10.1186/s41077-023-00255-2</a>" },
                    { name: "Non-volatile weak acid dissociation constant", value: formatScientific(values[1],2), unit: "mol.L⁻¹", description: "", justification: "Arbitrary choice" },
                    { name: "CO₂ , H₂O / HCO₃⁻ apparent dissociation constant", value: formatScientific(values[2], 2), unit: "mol.L⁻¹", description: "", justification: "From reference <a href='https://doi.org/10.1186/s41077-023-00255-2' target='_blank'>doi.org/10.1186/s41077-023-00255-2</a>" },
                    { name: "HCO₃⁻ / CO₃⁻² dissociation constant", value: formatScientific(values[3],2), unit: "mol.L⁻¹", justification: "From reference <a href='https://doi.org/10.1186/s41077-023-00255-2' target='_blank'>doi.org/10.1186/s41077-023-00255-2</a>" },
                    { name: "CO₂ solubility coefficient in plasma", value: (values[4]*1000).toFixed(2), unit: "mmol.L⁻¹.mmHg⁻¹", description: "", justification: "From reference <a href='https://doi.org/10.1186/s41077-023-00255-2' target='_blank'>doi.org/10.1186/s41077-023-00255-2</a>" },
                    { name: "Diffusion capacity of the lungs", value: (values[5]*1000).toFixed(2), unit: "mmol.min⁻¹.mmHg⁻¹", justification: "Calculated with other calibration values, assuming baseline alveolar pCO₂ is equal to baseline arterial pCO₂" },
                    { name: "Constant of the basic alveolar ventilation equation", value: formatScientific(values[6]/1000,0), unit: "mmHg.L.mmol⁻¹", justification: "Calculated with other calibration values, assuming baseline alveolar pCO₂ is equal to baseline arterial pCO₂" }
                ];
                const baselineInputs = [
                    { name: "Total Volume", value: values[7], unit: "L" , justification:"Assumed normal value"},
                    { name: "Strong Ion Difference", value: (values[8]*1000).toFixed(0), unit: "mmol.L⁻¹", justification: "Calculated with other calibration values to obtain baseline output values" },
                    { name: "Non-Volatile Weak Acid Content", value: values[9]*1000, unit: "mmol.L⁻¹", justification: "Calculated with other calibration values to obtain baseline output values" },
                    { name: "Alveolar Ventilation", value: values[10], unit: "L.min⁻¹", justification: "Assumed normal value" },
                    { name: "CO₂ production", value: values[11]*1000, unit: "mmol.min⁻¹", justification: "Assumed normal value" },
                    { name: "Cardiac Output", value: values[12], unit: "L.min⁻¹", justification: "Assumed normal value" }
                ];
                const baselineOutputs = [
                    { name: "Arterial pH", value: values[13], unit: "", justification: "Assumed normal value" },
                    { name: "Arterial pCO₂", value: values[14], unit: "mmHg", justification: "Assumed normal value" },
                    { name: "Veno-arterial difference of pCO₂", value: (values[15]-values[14]).toFixed(0), unit: "mmHg", justification: "Assumed normal value" }
                ];
                function fillTable(tableId, vars) {
                    const tableBody = document.getElementById(tableId);
                    tableBody.innerHTML = "";
                    for (const v of vars) {
                        const row = document.createElement("tr");
                        const nameCell = document.createElement("td");
                        const nameSpan = document.createElement("div");
                        nameSpan.textContent = v.name;
                        nameSpan.style.fontWeight = "bold";
                        nameCell.appendChild(nameSpan);
                        if (v.description) {
                            const descSpan = document.createElement("div");
                            descSpan.textContent = v.description;
                            descSpan.style.fontSize = "0.8em";
                            descSpan.style.fontStyle = "italic";
                            descSpan.style.color = "#666";
                            descSpan.style.marginTop = "2px";
                            nameCell.appendChild(descSpan);
                        }
                        row.appendChild(nameCell);

                        const valueCell = document.createElement("td");
                        valueCell.textContent = v.unit ? `${v.value} ${v.unit}` : v.value;
                        row.appendChild(valueCell);

                        const justificationCell = document.createElement("td");
                        justificationCell.innerHTML = v.justification || "";
                        row.appendChild(justificationCell);

                        tableBody.appendChild(row);
                    }
                }
                fillTable("var-table-const", constants);
                fillTable("var-table-baseline-input", baselineInputs);
                fillTable("var-table-baseline-output", baselineOutputs);
                document.getElementById("infoModal").style.display = "block";

            } catch (error) {
                console.error("Error showing init variables:", error);
            }
        }
      
        document.getElementById("btn-info").addEventListener("click", showInitVariables);
        
        document.querySelector(".close").addEventListener("click", function() {
            document.getElementById("infoModal").style.display = "none";
        });
        
        window.addEventListener("click", function(event) {
            if (event.target == document.getElementById("infoModal")) {
                document.getElementById("infoModal").style.display = "none";
            }
        });
    </script>
</body>
</html>

